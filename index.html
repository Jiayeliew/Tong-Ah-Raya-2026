<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Tong Ah Raya 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#ffffff; --surface:#fafafa; --surface2:#f3f3f3;
    --border:#e8e8e8; --border2:#d0d0d0;
    --text:#111111; --muted:#999999; --muted2:#cccccc;
    --gold:#c8960c; --gold-bg:#fdf8ec; --gold-border:#f0d87a;
    --green:#1a9a5a; --green-bg:#edfaf3; --green-border:#a3dfbf;
    --red:#d63b3b; --red-bg:#fff0f0; --red-border:#fca5a5;
    --blue:#1a6bc8; --blue-bg:#edf4fd; --blue-border:#b3d1f7;
    --amber:#d97706; --amber-bg:#fff8ec; --amber-border:#fcd97a;
    --purple:#7c3aed; --purple-bg:#f5f3ff; --purple-border:#c4b5fd;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  html,body{width:100%;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;}

  /* â”€â”€ Topbar â”€â”€ */
  .topbar{height:50px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:var(--bg);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;}
  .brand{font-family:'Playfair Display',serif;font-size:17px;font-weight:900;letter-spacing:1px;}
  .brand span{color:var(--gold);}
  .tb-clock{font-family:'DM Mono',monospace;font-size:17px;font-weight:500;letter-spacing:2px;}
  .tb-right{display:flex;align-items:center;gap:10px;}
  .tb-date{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);}
  .sync-pill{display:flex;align-items:center;gap:5px;padding:4px 9px;border-radius:20px;background:var(--surface2);border:1px solid var(--border2);cursor:pointer;font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:1px;user-select:none;}
  .sync-pill:hover{border-color:#aaa;color:var(--text);}
  .sync-dot{width:6px;height:6px;border-radius:50%;background:var(--muted2);flex-shrink:0;transition:background .3s;}
  .sync-dot.ok{background:var(--green);}
  .sync-dot.err{background:var(--red);animation:blink 1.5s infinite;}
  .sync-dot.spin{background:var(--amber);animation:blink .7s infinite;}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
  .setup-icon{background:none;border:none;cursor:pointer;color:var(--muted);font-size:15px;padding:4px;}
  .setup-icon:hover{color:var(--text);}

  /* â”€â”€ Tab bar â”€â”€ */
  .tabbar{display:flex;background:var(--bg);border-bottom:2px solid var(--border);position:sticky;top:50px;z-index:49;}
  .tab-btn{flex:1;padding:12px 8px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;color:var(--muted);background:none;border:none;border-bottom:2px solid transparent;margin-bottom:-2px;cursor:pointer;transition:all .15s;letter-spacing:.3px;}
  .tab-btn.active{color:var(--gold);border-bottom-color:var(--gold);font-weight:600;}
  .tab-btn:hover:not(.active){color:var(--text);}

  /* â”€â”€ Tab panels â”€â”€ */
  .tab-panel{display:none;}
  .tab-panel.active{display:block;}

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SALES TAB
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .sales-zone{display:flex;}
  .panel{flex:1;display:flex;flex-direction:column;padding:18px 26px 14px;gap:11px;}
  .panel-daily{border-right:1px solid var(--border);}
  .sec-label{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;margin-bottom:4px;}
  .panel-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;}
  .sales-row{display:flex;align-items:flex-end;gap:10px;flex-wrap:wrap;}
  .big-num{display:flex;align-items:flex-end;gap:3px;line-height:1;}
  .big-num .cur{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;padding-bottom:8px;color:var(--gold);}
  .big-num .cur.blue{color:var(--blue);}
  .big-num .amt{font-family:'Playfair Display',serif;font-size:68px;font-weight:900;letter-spacing:-2px;color:var(--text);}
  .update-btn{margin-bottom:8px;padding:7px 14px;background:var(--surface2);border:1.5px solid var(--border2);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .15s;white-space:nowrap;flex-shrink:0;}
  .update-btn:hover{border-color:var(--gold);color:var(--gold);background:var(--gold-bg);}
  .bonus-chip{background:var(--gold-bg);border:1px solid var(--gold-border);border-radius:12px;padding:10px 14px;display:flex;flex-direction:column;gap:4px;flex-shrink:0;min-width:155px;}
  .bonus-chip-lbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--gold);text-transform:uppercase;margin-bottom:2px;}
  .bonus-chip-top{display:flex;align-items:center;gap:10px;}
  .bonus-chip-amt{font-family:'Playfair Display',serif;font-size:26px;font-weight:900;color:var(--gold);line-height:1;}
  .bonus-chip-amt .rm{font-size:12px;margin-right:1px;}
  .bonus-total-row{display:flex;align-items:center;gap:6px;padding-top:4px;border-top:1px solid var(--gold-border);}
  .bonus-total-lbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:var(--gold);opacity:.7;}
  .bonus-total-amt{font-family:'DM Mono',monospace;font-size:12px;font-weight:500;color:var(--gold);}
  .overall-chip{text-align:right;flex-shrink:0;}
  .overall-amt{font-family:'Playfair Display',serif;font-size:26px;font-weight:900;color:var(--purple);line-height:1;}
  .overall-amt .rm{font-size:12px;margin-right:1px;}
  .overall-pct-row{font-family:'DM Mono',monospace;font-size:10px;color:var(--purple);opacity:.7;margin-top:3px;}
  .tiers{display:flex;flex-direction:column;justify-content:center;gap:11px;padding:6px 0;}
  .tier-row{display:flex;align-items:center;gap:10px;}
  .tier-pill{font-family:'DM Mono',monospace;font-size:11px;font-weight:500;width:36px;height:22px;border-radius:5px;display:flex;align-items:center;justify-content:center;flex-shrink:0;border:1px solid;}
  .pill-d{background:var(--gold-bg);border-color:var(--gold-border);color:var(--gold);}
  .pill-t{background:var(--blue-bg);border-color:var(--blue-border);color:var(--blue);}
  .bar-wrap{flex:1;height:10px;background:var(--surface2);border-radius:999px;overflow:hidden;min-width:40px;}
  .bar-fill{height:100%;border-radius:999px;transition:width 1.2s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden;}
  .bar-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent 60%,rgba(255,255,255,.5));animation:shim 2.5s infinite;}
  @keyframes shim{0%,100%{opacity:0}50%{opacity:1}}
  .ft1{background:linear-gradient(90deg,#e6b800,#c8960c);}
  .ft2{background:linear-gradient(90deg,#c8960c,#d97706);}
  .ft3{background:linear-gradient(90deg,#d97706,#b45309);}
  .ftt1{background:linear-gradient(90deg,#3b82f6,#1a6bc8);}
  .ftt2{background:linear-gradient(90deg,#1a6bc8,#4f46e5);}
  .ftt3{background:linear-gradient(90deg,#4f46e5,#7c3aed);}
  .tier-right{display:flex;align-items:center;gap:6px;width:260px;flex-shrink:0;justify-content:flex-end;flex-wrap:nowrap;}
  .tier-tgt{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);min-width:80px;text-align:right;}
  .tier-bonus{font-family:'DM Mono',monospace;font-size:10px;font-weight:500;padding:2px 6px;border-radius:4px;white-space:nowrap;background:var(--green-bg);border:1px solid var(--green-border);color:var(--green);min-width:70px;text-align:center;}
  .tier-bonus-pct{font-family:'DM Mono',monospace;font-size:10px;font-weight:500;padding:2px 6px;border-radius:4px;white-space:nowrap;background:var(--purple-bg);border:1px solid var(--purple-border);color:var(--purple);min-width:70px;text-align:center;}
  .tier-pct{font-family:'DM Mono',monospace;font-size:12px;font-weight:500;width:42px;text-align:right;color:var(--text);}
  .badge{font-family:'DM Mono',monospace;font-size:10px;padding:3px 7px;border-radius:5px;min-width:62px;text-align:center;border:1px solid;white-space:nowrap;}
  .bh{background:var(--green-bg);border-color:var(--green-border);color:var(--green);}
  .bc{background:var(--amber-bg);border-color:var(--amber-border);color:var(--amber);}
  .bm{background:var(--surface2);border-color:var(--border2);color:var(--muted);}
  @keyframes glowGold{0%,100%{box-shadow:none}50%{box-shadow:inset 0 0 0 2px var(--gold-border),0 0 30px 3px rgba(200,150,12,.08)}}
  .glow-gold{animation:glowGold 2.5s infinite;}

  /* Clock zone */
  .clock-zone{border-top:2px solid var(--border);background:var(--surface);display:flex;flex-wrap:wrap;}
  .cam-wrap{width:calc(26vh*1.25);flex-shrink:0;min-height:160px;position:relative;background:var(--surface2);border-right:1px solid var(--border);overflow:hidden;display:flex;align-items:center;justify-content:center;}
  #video{width:100%;height:100%;object-fit:cover;display:none;transform:scaleX(-1);}
  #canvas{display:none;position:absolute;top:0;left:0;width:100%;height:100%;}
  .cam-idle{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;pointer-events:none;}
  .cam-idle-icon{font-size:24px;opacity:.18;}
  .cam-idle-text{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--muted2);}
  .cam-rec{position:absolute;top:8px;right:8px;width:8px;height:8px;border-radius:50%;background:var(--red);display:none;animation:blink .8s infinite;}
  .emp-section{flex:1;min-width:180px;display:flex;flex-direction:column;justify-content:center;padding:12px 16px;gap:9px;border-right:1px solid var(--border);}
  .zone-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;}
  .emp-grid{display:flex;flex-wrap:wrap;gap:7px;}
  .emp-btn{background:var(--bg);border:1px solid var(--border2);border-radius:8px;padding:7px 16px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;cursor:pointer;transition:all .12s;white-space:nowrap;}
  .emp-btn:hover,.emp-btn.sel{background:var(--gold-bg);border-color:var(--gold-border);color:var(--gold);font-weight:600;}
  .punch-section{width:155px;flex-shrink:0;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:12px;gap:8px;border-right:1px solid var(--border);}
  .btn-in,.btn-out{width:100%;height:40px;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .12s;}
  .btn-in{background:var(--green);border:none;color:#fff;}
  .btn-out{background:var(--bg);border:1.5px solid var(--border2);color:var(--muted);}
  .btn-in:active{transform:scale(.97);}
  .btn-out:hover{border-color:var(--red);color:var(--red);}
  .feed-section{flex:1;min-width:120px;display:flex;flex-direction:column;padding:10px 12px;gap:6px;overflow:hidden;}
  .feed-scroll{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:4px;max-height:140px;}
  .feed-item{display:flex;align-items:center;gap:7px;font-size:12px;padding:5px 9px;background:var(--bg);border:1px solid var(--border);border-radius:7px;flex-shrink:0;}
  .fdot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
  .fdot-in{background:var(--green);} .fdot-out{background:var(--red);}
  .fname{font-weight:600;} .ftype{font-size:10px;color:var(--muted);}
  .ftime{margin-left:auto;font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);}
  .settings-col{width:42px;flex-shrink:0;display:flex;flex-direction:column;align-items:center;justify-content:center;border-left:1px solid var(--border);}
  .settings-btn{writing-mode:vertical-rl;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--muted);cursor:pointer;background:none;border:none;padding:8px;transition:color .15s;}
  .settings-btn:hover{color:var(--text);}

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STOCK COUNT TAB
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .stock-page{padding:20px;}
  .stock-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px;}
  .stock-title{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;}
  .stock-subtitle{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);margin-top:3px;}
  .stock-emp-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .stock-emp-label{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--muted);}
  .stock-emp-select{padding:8px 12px;border:1.5px solid var(--border2);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--text);background:var(--bg);cursor:pointer;outline:none;}
  .stock-emp-select:focus{border-color:var(--gold);}

  /* Stock table */
  .stock-table{width:100%;border-collapse:separate;border-spacing:0;border-radius:12px;border:1px solid var(--border);}
  .stock-table th{position:sticky;top:0;z-index:2;background:var(--surface2);padding:10px 14px;text-align:left;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;color:var(--muted);font-weight:500;border-bottom:1px solid var(--border);}
  .stock-table th:nth-child(1){position:sticky;left:0;top:0;z-index:4;background:var(--surface2);border-right:2px solid var(--border2);box-shadow:2px 0 6px rgba(0,0,0,.06);}
  .stock-table td:nth-child(1){position:sticky;left:0;z-index:2;background:var(--bg);border-right:2px solid var(--border2);box-shadow:2px 0 6px rgba(0,0,0,.06);}
  .stock-table tr:hover td:nth-child(1){background:var(--surface);}
  .stock-table td{padding:10px 14px;border-bottom:1px solid var(--border);font-size:14px;vertical-align:middle;}
  .stock-table tr:last-child td{border-bottom:none;}
  .stock-table tr:hover td{background:var(--surface);}
  .sku-code{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);}
  .sku-name{font-weight:500;}
  .par-badge{font-family:'DM Mono',monospace;font-size:11px;color:var(--blue);background:var(--blue-bg);border:1px solid var(--blue-border);padding:2px 7px;border-radius:4px;}
  .qty-input{width:80px;padding:7px 10px;border:1.5px solid var(--border2);border-radius:7px;font-family:'DM Mono',monospace;font-size:15px;font-weight:500;text-align:center;color:var(--text);background:var(--bg);outline:none;transition:border-color .15s;}
  .qty-input:focus{border-color:var(--gold);}
  .qty-input.ok{border-color:var(--green);background:var(--green-bg);}
  .qty-input.warn{border-color:var(--amber);background:var(--amber-bg);}
  .qty-input.low{border-color:var(--red);background:var(--red-bg);}

  .stock-footer{margin-top:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;}
  .stock-progress{font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);}
  .stock-progress span{color:var(--text);font-weight:500;}
  .submit-stock-btn{padding:12px 28px;background:var(--green);border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;color:#fff;cursor:pointer;transition:all .15s;}
  .submit-stock-btn:hover{opacity:.88;}
  .submit-stock-btn:disabled{background:var(--muted2);cursor:not-allowed;}
  .stock-submitted-banner{background:var(--green-bg);border:1px solid var(--green-border);border-radius:10px;padding:14px 18px;font-family:'DM Mono',monospace;font-size:13px;color:var(--green);display:none;}

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     REORDER TAB
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .reorder-page{padding:20px;}
  .reorder-header{margin-bottom:20px;}
  .reorder-title{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;}
  .reorder-subtitle{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);margin-top:3px;}
  .reorder-grid{display:flex;flex-direction:column;gap:10px;}
  .reorder-card{display:flex;align-items:center;gap:14px;padding:14px 18px;border-radius:12px;border:1px solid;}
  .reorder-card.urgent{background:var(--red-bg);border-color:var(--red-border);}
  .reorder-card.low{background:var(--amber-bg);border-color:var(--amber-border);}
  .reorder-card.ok{background:var(--green-bg);border-color:var(--green-border);}
  .reorder-card.pending{background:var(--surface2);border-color:var(--border);}
  .rc-icon{font-size:20px;flex-shrink:0;}
  .rc-info{flex:1;min-width:0;}
  .rc-name{font-weight:600;font-size:14px;}
  .rc-sku{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-top:1px;}
  .rc-right{text-align:right;flex-shrink:0;}
  .rc-qty{font-family:'Playfair Display',serif;font-size:22px;font-weight:900;line-height:1;}
  .rc-qty.urgent{color:var(--red);}
  .rc-qty.low{color:var(--amber);}
  .rc-qty.ok{color:var(--green);}
  .rc-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:var(--muted);margin-top:2px;}
  .rc-actual{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);margin-top:2px;}
  .reorder-empty{text-align:center;padding:40px;font-family:'DM Mono',monospace;font-size:13px;color:var(--muted);}
  .reorder-no-count{text-align:center;padding:40px;}
  .reorder-no-count p{font-family:'DM Mono',monospace;font-size:13px;color:var(--muted);margin-bottom:12px;}

  /* Summary bar */
  .reorder-summary{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
  .sum-chip{flex:1;min-width:80px;padding:12px 14px;border-radius:10px;text-align:center;border:1px solid;}
  .sum-chip.urgent{background:var(--red-bg);border-color:var(--red-border);}
  .sum-chip.low{background:var(--amber-bg);border-color:var(--amber-border);}
  .sum-chip.ok{background:var(--green-bg);border-color:var(--green-border);}
  .sum-chip .num{font-family:'Playfair Display',serif;font-size:28px;font-weight:900;}
  .sum-chip.urgent .num{color:var(--red);}
  .sum-chip.low .num{color:var(--amber);}
  .sum-chip.ok .num{color:var(--green);}
  .sum-chip .lbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;margin-top:2px;}
  .sum-chip.urgent .lbl{color:var(--red);}
  .sum-chip.low .lbl{color:var(--amber);}
  .sum-chip.ok .lbl{color:var(--green);}

  /* Shared modals & toasts */
  .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(16px);padding:9px 22px;border-radius:8px;font-family:'DM Mono',monospace;font-size:13px;opacity:0;transition:all .22s;z-index:200;pointer-events:none;white-space:nowrap;color:#fff;}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
  .toast.ok{background:var(--green);} .toast.err{background:var(--red);} .toast.info{background:var(--text);}
  .flash{position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:99;transition:opacity .06s;}
  .flash.on{opacity:.5;}

  .update-modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:300;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
  .update-modal-bg.open{display:flex;}
  .update-modal{background:var(--bg);border:1px solid var(--border2);border-radius:16px;padding:28px;width:min(340px,90vw);display:flex;flex-direction:column;gap:18px;box-shadow:0 20px 60px rgba(0,0,0,.12);}
  .um-title{font-family:'Playfair Display',serif;font-size:18px;font-weight:700;}
  .um-sub{font-size:13px;color:var(--muted);margin-top:4px;}
  .um-input-wrap{display:flex;align-items:center;border:1.5px solid var(--border2);border-radius:9px;overflow:hidden;transition:border-color .15s;}
  .um-input-wrap:focus-within{border-color:var(--gold);}
  .um-prefix{padding:0 12px;font-family:'DM Mono',monospace;font-size:15px;font-weight:500;color:var(--gold);background:var(--gold-bg);border-right:1px solid var(--gold-border);height:52px;display:flex;align-items:center;flex-shrink:0;}
  .um-input{flex:1;height:52px;border:none;outline:none;padding:0 14px;font-family:'Playfair Display',serif;font-size:26px;font-weight:700;color:var(--text);background:var(--bg);}
  .um-actions{display:flex;gap:8px;}
  .um-confirm{flex:1;background:var(--green);border:none;border-radius:9px;height:46px;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;color:#fff;cursor:pointer;}
  .um-confirm:hover{opacity:.85;}
  .um-cancel{background:var(--bg);border:1.5px solid var(--border2);border-radius:9px;height:46px;padding:0 18px;font-family:'DM Sans',sans-serif;font-size:15px;color:var(--muted);cursor:pointer;}

  .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
  .modal-bg.open{display:flex;}
  .modal{background:var(--bg);border:1px solid var(--border2);border-radius:16px;padding:28px;width:min(480px,92vw);max-height:90vh;overflow-y:auto;display:flex;flex-direction:column;gap:16px;box-shadow:0 20px 60px rgba(0,0,0,.15);}
  .modal-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;}
  .fg{display:flex;flex-direction:column;gap:6px;}
  .fl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;}
  input[type=text]{background:var(--surface2);border:1px solid var(--border2);border-radius:7px;padding:9px 11px;color:var(--text);font-family:'DM Mono',monospace;font-size:11px;width:100%;outline:none;}
  input:focus{border-color:var(--gold);}
  .status-box{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;font-size:12px;line-height:2;font-family:'DM Mono',monospace;}
  .status-box .ok{color:var(--green);} .status-box .er{color:var(--red);} .status-box .warn{color:var(--amber);}
  .ma{display:flex;gap:8px;flex-wrap:wrap;}
  .btn-save{flex:1;background:var(--text);border:none;border-radius:8px;padding:12px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;color:#fff;}
  .btn-save:hover{opacity:.8;}
  .btn-test{background:var(--bg);border:1.5px solid var(--border2);border-radius:8px;padding:12px 14px;font-family:'DM Sans',sans-serif;font-size:14px;cursor:pointer;color:var(--muted);}
  .btn-test:hover{border-color:var(--blue);color:var(--blue);}
  .btn-cancel{background:var(--bg);border:1.5px solid var(--border2);border-radius:8px;padding:12px 14px;font-family:'DM Sans',sans-serif;font-size:14px;cursor:pointer;color:var(--muted);}
  ::-webkit-scrollbar{width:3px;} ::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

  /* Mobile */
  @media (max-width:700px){
    .sales-zone{flex-direction:column;}
    .panel-daily{border-right:none;border-bottom:1px solid var(--border);}
    .big-num .amt{font-size:48px;}
    .cam-wrap{width:100%!important;border-right:none;border-bottom:1px solid var(--border);}
    .tier-right{width:auto;}
    /* SKU column visible on all screens */
  }
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="brand">Tong Ah <span>Raya 2026</span></div>
  <div class="tb-clock" id="liveClock">--:--:--</div>
  <div class="tb-right">
    <div class="tb-date" id="liveDate">--</div>
    <div class="sync-pill" onclick="manualRefresh()" title="Tap to refresh">
      <div class="sync-dot" id="syncDot"></div>
      <span id="syncText">SETUP</span>
    </div>
    <button class="setup-icon" onclick="openModal()">âš™</button>
  </div>
</div>

<!-- Tab bar -->
<div class="tabbar">
  <button class="tab-btn active" onclick="switchTab('sales',this)">ğŸ“Š Sales</button>
  <button class="tab-btn" onclick="switchTab('stock',this)">ğŸ“¦ Stock Count</button>
  <button class="tab-btn" onclick="switchTab('reorder',this)">ğŸ”” è£œè²¨éœ€æ±‚</button>
</div>

<!-- â•â•â•â•â•â•â•â• TAB: SALES â•â•â•â•â•â•â•â• -->
<div class="tab-panel active" id="tab-sales">
  <div class="sales-zone">
    <div class="panel panel-daily" id="dailyCard">
      <div class="panel-head">
        <div>
          <div class="sec-label">Today's Sales</div>
          <div class="sales-row">
            <div class="big-num"><span class="cur">RM</span><span class="amt" id="dailyAmt">â€”</span></div>
            <button class="update-btn" onclick="openUpdateModal()">âœ Update</button>
          </div>
        </div>
        <div class="bonus-chip">
          <div class="bonus-chip-lbl">Daily Bonus</div>
          <div class="bonus-chip-top">
            <div class="bonus-chip-amt"><span class="rm">RM</span><span id="commAmt">â€”</span></div>
            <div class="badge bm" id="commStatus">â€”</div>
          </div>
          <div class="bonus-total-row">
            <span class="bonus-total-lbl">TOTAL BONUS</span>
            <span class="bonus-total-amt">RM <span id="totalBonusAmt">â€”</span></span>
          </div>
        </div>
      </div>
      <div class="tiers">
        <div class="tier-row"><div class="tier-pill pill-d">T1</div><div class="bar-wrap"><div class="bar-fill ft1" id="t1Bar" style="width:0"></div></div><div class="tier-right"><span class="tier-tgt" id="t1Tgt">â€”</span><span class="tier-bonus" id="t1Bonus">â€”</span><span class="tier-pct" id="t1Pct">â€”</span><span class="badge bm" id="t1Badge">â€”</span></div></div>
        <div class="tier-row"><div class="tier-pill pill-d">T2</div><div class="bar-wrap"><div class="bar-fill ft2" id="t2Bar" style="width:0"></div></div><div class="tier-right"><span class="tier-tgt" id="t2Tgt">â€”</span><span class="tier-bonus" id="t2Bonus">â€”</span><span class="tier-pct" id="t2Pct">â€”</span><span class="badge bm" id="t2Badge">â€”</span></div></div>
        <div class="tier-row"><div class="tier-pill pill-d">T3</div><div class="bar-wrap"><div class="bar-fill ft3" id="t3Bar" style="width:0"></div></div><div class="tier-right"><span class="tier-tgt" id="t3Tgt">â€”</span><span class="tier-bonus" id="t3Bonus">â€”</span><span class="tier-pct" id="t3Pct">â€”</span><span class="badge bm" id="t3Badge">â€”</span></div></div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-head">
        <div>
          <div class="sec-label">Total Sales</div>
          <div class="big-num"><span class="cur blue">RM</span><span class="amt" id="totalAmt">â€”</span></div>
        </div>
        <div class="overall-chip">
          <div class="sec-label">Overall Comm</div>
          <div class="overall-amt"><span class="rm">RM</span><span id="overallComm">â€”</span></div>
          <div class="overall-pct-row" id="overallPctRow">â€”</div>
        </div>
      </div>
      <div class="tiers">
        <div class="tier-row"><div class="tier-pill pill-t">TT1</div><div class="bar-wrap"><div class="bar-fill ftt1" id="tt1Bar" style="width:0"></div></div><div class="tier-right"><span class="tier-tgt" id="tt1Tgt">â€”</span><span class="tier-bonus-pct" id="tt1BonusPct">â€”</span><span class="tier-pct" id="tt1Pct">â€”</span><span class="badge bm" id="tt1Badge">â€”</span></div></div>
        <div class="tier-row"><div class="tier-pill pill-t">TT2</div><div class="bar-wrap"><div class="bar-fill ftt2" id="tt2Bar" style="width:0"></div></div><div class="tier-right"><span class="tier-tgt" id="tt2Tgt">â€”</span><span class="tier-bonus-pct" id="tt2BonusPct">â€”</span><span class="tier-pct" id="tt2Pct">â€”</span><span class="badge bm" id="tt2Badge">â€”</span></div></div>
        <div class="tier-row"><div class="tier-pill pill-t">TT3</div><div class="bar-wrap"><div class="bar-fill ftt3" id="tt3Bar" style="width:0"></div></div><div class="tier-right"><span class="tier-tgt" id="tt3Tgt">â€”</span><span class="tier-bonus-pct" id="tt3BonusPct">â€”</span><span class="tier-pct" id="tt3Pct">â€”</span><span class="badge bm" id="tt3Badge">â€”</span></div></div>
      </div>
    </div>
  </div>
  <!-- Clock zone -->
  <div class="clock-zone">
    <div class="cam-wrap" style="min-height:160px;">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>
      <div class="cam-idle" id="camIdle"><div class="cam-idle-icon">ğŸ“·</div><div class="cam-idle-text">SELECT EMPLOYEE</div></div>
      <div class="cam-rec" id="camRec"></div>
    </div>
    <div class="emp-section">
      <div class="zone-label">Select Employee</div>
      <div class="emp-grid" id="empGrid"><div style="font-size:12px;color:var(--muted)">Loadingâ€¦</div></div>
    </div>
    <div class="punch-section">
      <div class="zone-label">Punch</div>
      <button class="btn-in"  onclick="doAction('IN')">â–¶ Clock In</button>
      <button class="btn-out" onclick="doAction('OUT')">â–  Clock Out</button>
    </div>
    <div class="feed-section">
      <div class="zone-label">Recent</div>
      <div class="feed-scroll" id="feedScroll"></div>
    </div>
    <div class="settings-col"><button class="settings-btn" onclick="openModal()">âš™ SETUP</button></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• TAB: Stock Count â•â•â•â•â•â•â•â• -->
<div class="tab-panel" id="tab-stock">
  <div class="stock-page">
    <div class="stock-header">
      <div>
        <div class="stock-title">ğŸ“¦ Evening Stock Count</div>
        <div class="stock-subtitle" id="stockSubtitle">Raya 2026 Â· Loadingâ€¦</div>
      </div>
      <div class="stock-emp-row">
        <span class="stock-emp-label">DONE BY</span>
        <select class="stock-emp-select" id="stockEmpSelect">
          <option value="">Select Employee</option>
        </select>
      </div>
    </div>
    <div class="stock-submitted-banner" id="stockSubmittedBanner" style="display:none">
      âœ… Stock count submitted today. You can submit again to overwrite with corrected data.
    </div>
    <div style="overflow-x:auto;overflow-y:auto;max-height:calc(100vh - 200px);position:relative;">
    <table class="stock-table" style="min-width:900px;">
      <thead>
        <tr>
          <th>SKU</th>
          <th>Product</th>
          <th style="text-align:center">Open B/D</th>
          <th style="text-align:center;background:#f0faf4;color:var(--green)">+HQ</th>
          <th style="text-align:center;background:#f0faf4;color:var(--green)">+Transfer</th>
          <th style="text-align:center;background:var(--surface)">Subtotal</th>
          <th style="text-align:center;background:#fff5f5;color:var(--red)">âˆ’Sales</th>
          <th style="text-align:center;background:#fff5f5;color:var(--red)">âˆ’Sample</th>
          <th style="text-align:center;background:#fff5f5;color:var(--red)">âˆ’Faulty</th>
          <th style="text-align:center;background:#fff5f5;color:var(--red)">âˆ’FOC</th>
          <th style="text-align:center;background:var(--blue-bg);color:var(--blue)">Actual Qty</th>
          <th style="text-align:center;background:var(--gold-bg);color:var(--gold)">Closing C/D</th>
          <th style="min-width:120px">Remarks</th>
          <th style="text-align:center">PAR</th>
        </tr>
      </thead>
      <tbody id="stockTableBody">
        <tr><td colspan="14" style="text-align:center;padding:30px;color:var(--muted);font-family:'DM Mono',monospace;font-size:12px;">Loading productsâ€¦</td></tr>
      </tbody>
    </table>
    </div>
    <div class="stock-footer">
      <div class="stock-progress">Filled: <span id="stockFilled">0</span> / <span id="stockTotal">0</span></div>
      <button class="submit-stock-btn" id="submitStockBtn" onclick="submitStock()">Submit Stock Count</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â• TAB: è£œè²¨éœ€æ±‚ â•â•â•â•â•â•â•â• -->
<div class="tab-panel" id="tab-reorder">
  <div class="reorder-page">
    <div class="reorder-header">
      <div class="reorder-title">ğŸ”” Reorder Requirements</div>
      <div class="reorder-subtitle" id="reorderSubtitle">Based on last stock count</div>
    </div>
    <div class="reorder-summary" id="reorderSummary"></div>
    <div class="reorder-grid" id="reorderGrid">
      <div class="reorder-no-count">
        <p>No stock count submitted yet today.</p>
        <button class="submit-stock-btn" onclick="switchTab('stock',this)" style="background:var(--blue)">Go to Stock Count â†’</button>
      </div>
    </div>
  </div>
</div>

<div class="flash" id="flash"></div>
<div class="toast" id="toast"></div>

<!-- Update Sales Modal -->
<div class="update-modal-bg" id="updateModalBg">
  <div class="update-modal">
    <div><div class="um-title">Update Today's Sales</div><div class="um-sub">Saves directly to Google Sheets</div></div>
    <div class="um-input-wrap"><div class="um-prefix">RM</div><input class="um-input" id="umInput" type="number" placeholder="0" min="0" inputmode="decimal"></div>
    <div class="um-actions"><button class="um-confirm" onclick="confirmUpdate()">Confirm</button><button class="um-cancel" onclick="closeUpdateModal()">Cancel</button></div>
  </div>
</div>

<!-- Setup Modal -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <div class="modal-title">Connect Google Sheets</div>
    <div class="fg"><div class="fl">Apps Script URL</div><input id="s_url" type="text" placeholder="https://script.google.com/macros/s/AKfycbwuAR5LAOq9bmvQBSMisn9KohzpoRSKHX4DkD-3CwYqijydkdLPM4vRHtUUKqWJb6gQ/exec"></div>
    <div class="status-box" id="statusBox">Paste your URL and click Test</div>
    <div class="ma">
      <button class="btn-test" onclick="testConn()">Test Connection</button>
      <button class="btn-save" onclick="saveSettings()">Save</button>
      <button class="btn-cancel" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>

<script>
var SHEET_URL = "https://script.google.com/macros/s/AKfycbwuAR5LAOq9bmvQBSMisn9KohzpoRSKHX4DkD-3CwYqijydkdLPM4vRHtUUKqWJb6gQ/exec";
var selEmp=null, camStream=null, syncTimer=null, lastData=null, stockData=null;

// â”€â”€ Clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tick(){
  var n=new Date();
  document.getElementById("liveClock").textContent=n.toLocaleTimeString("en-MY",{hour12:false});
  document.getElementById("liveDate").textContent=n.toLocaleDateString("en-MY",{weekday:"short",day:"numeric",month:"short"});
}

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name,btn){
  document.querySelectorAll(".tab-panel").forEach(function(p){p.classList.remove("active");});
  document.querySelectorAll(".tab-btn").forEach(function(b){b.classList.remove("active");});
  document.getElementById("tab-"+name).classList.add("active");
  if(btn) btn.classList.add("active");
  if(name==="stock") loadStockTab();
  if(name==="reorder") loadReorderTab();
}

// â”€â”€ JSONP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function jsonpFetch(url){
  return new Promise(function(resolve,reject){
    var cb="_cb_"+Date.now()+"_"+Math.random().toString(36).slice(2);
    var s=document.createElement("script");
    var t=setTimeout(function(){cleanup();reject(new Error("Timeout"));},12000);
    function cleanup(){clearTimeout(t);delete window[cb];if(s.parentNode)s.parentNode.removeChild(s);}
    window[cb]=function(d){cleanup();resolve(d);};
    s.onerror=function(){cleanup();reject(new Error("Script failed"));};
    s.src=url+(url.indexOf("?")>=0?"&":"?")+"callback="+cb+"&_t="+Date.now();
    document.head.appendChild(s);
  });
}

function setSyncUI(s,l){document.getElementById("syncDot").className="sync-dot"+(s?" "+s:"");document.getElementById("syncText").textContent=l;}

// â”€â”€ Sales Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animN(el,to){
  if(isNaN(to)) return;
  var from=parseFloat(el.textContent.replace(/[RM,â€”%]/g,""))||0;
  var t0=performance.now(),dur=900;
  function step(t){var p=Math.min((t-t0)/dur,1),e=1-Math.pow(1-p,3);el.textContent=Math.round(from+(to-from)*e).toLocaleString();if(p<1)requestAnimationFrame(step);}
  requestAnimationFrame(step);
}

function setBadge(el,cur,tgt){
  if(!tgt){el.textContent="â€”";el.className="badge bm";return;}
  var pct=cur/tgt*100;
  if(cur>=tgt)    {el.textContent="Hit âœ“";el.className="badge bh";}
  else if(pct>=80){el.textContent="Close!";el.className="badge bc";}
  else            {var gap=tgt-cur;el.textContent=gap>=1000?"RM "+(gap/1000).toFixed(1)+"k":"RM "+gap.toLocaleString();el.className="badge bm";}
}

function renderDash(d){
  lastData=d;
  var ds=d.daily_sales||0, ts=d.total_sales||0;  // C col already includes today
  var t1=d.t1||0,t2=d.t2||0,t3=d.t3||0;
  var b1=d.bonus1||0,b2=d.bonus2||0,b3=d.bonus3||0,tb=d.total_bonus||0;
  var tt1=d.tt1||0,tt2=d.tt2||0,tt3=d.tt3||0;
  var p1=d.tt1_pct||0,p2=d.tt2_pct||0,p3=d.tt3_pct||0;

  animN(document.getElementById("dailyAmt"),ds);
  animN(document.getElementById("totalAmt"),ts);

  function dailyTier(bId,pId,tId,boId,bdId,cur,tgt,bonus){
    var pct=tgt?Math.min(cur/tgt*100,100):0;
    document.getElementById(bId).style.width=pct+"%";
    document.getElementById(pId).textContent=tgt?pct.toFixed(0)+"%":"â€”";
    document.getElementById(tId).textContent=tgt?"RM "+tgt.toLocaleString():"â€”";
    document.getElementById(boId).textContent=bonus?"RM "+bonus.toLocaleString():"â€”";
    setBadge(document.getElementById(bdId),cur,tgt);
  }
  dailyTier("t1Bar","t1Pct","t1Tgt","t1Bonus","t1Badge",ds,t1,b1);
  dailyTier("t2Bar","t2Pct","t2Tgt","t2Bonus","t2Badge",ds,t2,b2);
  dailyTier("t3Bar","t3Pct","t3Tgt","t3Bonus","t3Badge",ds,t3,b3);

  var cA=document.getElementById("commAmt"),cS=document.getElementById("commStatus"),dc=document.getElementById("dailyCard");
  var earned=0;
  if(t3&&ds>=t3)     {earned=b3;cS.textContent="T3 Hit!";cS.className="badge bh";dc.classList.add("glow-gold");}
  else if(t2&&ds>=t2){earned=b2;cS.textContent="T2 Hit!";cS.className="badge bh";dc.classList.add("glow-gold");}
  else if(t1&&ds>=t1){earned=b1;cS.textContent="T1 Hit!";cS.className="badge bc";dc.classList.add("glow-gold");}
  else               {earned=0; cS.textContent="Not yet"; cS.className="badge bm";dc.classList.remove("glow-gold");}
  animN(cA,earned);
  document.getElementById("totalBonusAmt").textContent=(tb+earned).toLocaleString();

  function totalTier(bId,pId,tId,bpId,bdId,cur,tgt,rate){
    var pct=tgt?Math.min(cur/tgt*100,100):0;
    document.getElementById(bId).style.width=pct+"%";
    document.getElementById(pId).textContent=tgt?pct.toFixed(0)+"%":"â€”";
    document.getElementById(tId).textContent=tgt?"RM "+tgt.toLocaleString():"â€”";
    document.getElementById(bpId).textContent=rate?rate+"% comm":"â€”";
    setBadge(document.getElementById(bdId),cur,tgt);
  }
  totalTier("tt1Bar","tt1Pct","tt1Tgt","tt1BonusPct","tt1Badge",ts,tt1,p1);
  totalTier("tt2Bar","tt2Pct","tt2Tgt","tt2BonusPct","tt2Badge",ts,tt2,p2);
  totalTier("tt3Bar","tt3Pct","tt3Tgt","tt3BonusPct","tt3Badge",ts,tt3,p3);

  var BASE=0.5, activePct=BASE, tierLabel=BASE+"% (base)";
  if(p3&&ts>=tt3)     {activePct=p3;tierLabel=p3+"% (TT3 unlocked)";}
  else if(p2&&ts>=tt2){activePct=p2;tierLabel=p2+"% (TT2 unlocked)";}
  else if(p1&&ts>=tt1){activePct=p1;tierLabel=p1+"% (TT1 unlocked)";}
  var calcComm=ts?parseFloat((ts*activePct/100).toFixed(2)):0;
  document.getElementById("overallComm").textContent=calcComm.toLocaleString("en-MY",{minimumFractionDigits:2,maximumFractionDigits:2});
  document.getElementById("overallPctRow").textContent=ts?tierLabel+" Ã— RM "+ts.toLocaleString():"â€”";
}

function renderEmps(emps){
  var g=document.getElementById("empGrid"); g.innerHTML="";
  var sel=document.getElementById("stockEmpSelect");
  // Keep first option
  while(sel.options.length>1) sel.remove(1);
  if(!emps||!emps.length){g.innerHTML="<div style=\"font-size:12px;color:var(--muted)\">No employees</div>";return;}
  for(var i=0;i<emps.length;i++){
    (function(name){
      var b=document.createElement("button"); b.className="emp-btn"; b.textContent=name;
      b.onclick=function(){selEmp=name;document.querySelectorAll(".emp-btn").forEach(function(x){x.classList.remove("sel");});b.classList.add("sel");startCam();};
      g.appendChild(b);
      var opt=document.createElement("option"); opt.value=name; opt.textContent=name;
      sel.appendChild(opt);
    })(emps[i]);
  }
}

async function fetchSheets(silent){
  setSyncUI("spin","SYNCING");
  try{
    var d=await jsonpFetch(SHEET_URL);
    setSyncUI("ok","LIVE"); renderDash(d); renderEmps(d.employees||[]);
    if(!silent) showToast("Refreshed","ok");
    return d;
  }catch(err){
    setSyncUI("err","ERROR");
    if(!silent) showToast(err.message,"err");
    return null;
  }
}

function manualRefresh(){fetchSheets(false);}
function startAutoSync(){fetchSheets(true);syncTimer=setInterval(function(){fetchSheets(true);},60000);}

// â”€â”€ Stock Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var stockProducts=[];

async function loadStockTab(){
  var tbody=document.getElementById("stockTableBody");
  tbody.innerHTML='<tr><td colspan="14" style="text-align:center;padding:30px;color:var(--muted);font-family:DM Mono,monospace;font-size:12px;">Loadingâ€¦</td></tr>';
  try{
    var d=await jsonpFetch(SHEET_URL+"?action=stock");
    stockData=d; stockProducts=d.products||[];
    document.getElementById("stockSubtitle").textContent=d.store+" Â· "+d.date;
    document.getElementById("stockSubmittedBanner").style.display=d.submitted?"block":"none";
    renderStockTable(stockProducts);
  }catch(err){
    tbody.innerHTML='<tr><td colspan="14" style="text-align:center;padding:30px;color:var(--red);font-size:12px;">Failed to load: '+err.message+'</td></tr>';
  }
}

function renderStockTable(products){
  var tbody=document.getElementById("stockTableBody");
  tbody.innerHTML="";
  document.getElementById("stockTotal").textContent=products.length;
  for(var i=0;i<products.length;i++){
    var p=products[i];
    var tr=document.createElement("tr"); tr.id="stock-row-"+i;
    var hq=p.stock_in_hq!==null?p.stock_in_hq:"";
    var tf=p.stock_in_transfer!==null?p.stock_in_transfer:"";
    var sl=p.sales!==null?p.sales:"";
    var sm=p.sample!==null?p.sample:"";
    var fa=p.faulty!==null?p.faulty:"";
    var fo=p.foc!==null?p.foc:"";
    var cl=p.closing_cd!==null?p.closing_cd:"";
    var rm=p.remarks||"";
    tr.innerHTML=
      '<td class="sku-code">'+p.sku+'</td>'
      +'<td class="sku-name">'+p.name+'</td>'
      +'<td style="text-align:center;font-family:DM Mono,monospace;font-size:13px;color:var(--blue);font-weight:600">'+p.opening_bd+'</td>'
      +'<td style="text-align:center"><input class="qty-input" type="number" min="0" placeholder="0" value="'+hq+'" data-idx="'+i+'" data-field="stock_in_hq" oninput="onStockInput(this)"></td>'
      +'<td style="text-align:center"><input class="qty-input" type="number" min="0" placeholder="0" value="'+tf+'" data-idx="'+i+'" data-field="stock_in_transfer" oninput="onStockInput(this)"></td>'
      +'<td style="text-align:center;background:var(--surface);font-family:DM Mono,monospace;font-weight:600;font-size:13px" id="subtotal-'+i+'">â€”</td>'
      +'<td style="text-align:center"><input class="qty-input" type="number" min="0" placeholder="0" value="'+sl+'" data-idx="'+i+'" data-field="sales" oninput="onStockInput(this)"></td>'
      +'<td style="text-align:center"><input class="qty-input" type="number" min="0" placeholder="0" value="'+sm+'" data-idx="'+i+'" data-field="sample" oninput="onStockInput(this)"></td>'
      +'<td style="text-align:center"><input class="qty-input" type="number" min="0" placeholder="0" value="'+fa+'" data-idx="'+i+'" data-field="faulty" oninput="onStockInput(this)"></td>'
      +'<td style="text-align:center"><input class="qty-input" type="number" min="0" placeholder="0" value="'+fo+'" data-idx="'+i+'" data-field="foc" oninput="onStockInput(this)"></td>'
      +'<td style="text-align:center;background:var(--blue-bg);font-family:DM Mono,monospace;font-weight:700;color:var(--blue);font-size:14px" id="actual-'+i+'">â€”</td>'
      +'<td style="text-align:center"><input class="qty-input" type="number" min="0" placeholder="â€”" value="'+cl+'" data-idx="'+i+'" data-field="closing_cd" id="closing-'+i+'" oninput="onClosingInput(this)" style="background:var(--gold-bg);border-color:var(--gold-border);width:72px"></td>'
      +'<td><input type="text" placeholder="Required if closing â‰  actual" value="'+rm+'" data-idx="'+i+'" id="remarks-'+i+'" oninput="stockProducts[parseInt(this.dataset.idx)].remarks=this.value;checkRemarks(parseInt(this.dataset.idx))" style="width:100%;min-width:110px;font-size:12px;padding:6px 8px;border:1.5px solid var(--border2);border-radius:6px;outline:none;display:none"></td>'
      +'<td style="text-align:center"><span class="par-badge">'+p.par+'</span></td>';
    tbody.appendChild(tr);
    recalcRow(i);
  }
  updateStockProgress();
}

function getFieldVal(idx, field){
  var row=document.getElementById("stock-row-"+idx); if(!row) return 0;
  var el=row.querySelector('[data-field="'+field+'"]');
  return (el&&el.value!=="") ? (parseFloat(el.value)||0) : 0;
}

function recalcRow(idx){
  var p=stockProducts[idx];
  var opening=p.opening_bd||0;
  var hq=getFieldVal(idx,"stock_in_hq"), tf=getFieldVal(idx,"stock_in_transfer");
  var subtotal=opening+hq+tf;
  var sales=getFieldVal(idx,"sales"), sample=getFieldVal(idx,"sample");
  var faulty=getFieldVal(idx,"faulty"), foc=getFieldVal(idx,"foc");
  var actual=subtotal-sales-sample-faulty-foc;

  var stEl=document.getElementById("subtotal-"+idx);
  if(stEl) stEl.textContent=subtotal;
  var acEl=document.getElementById("actual-"+idx);
  if(acEl){ acEl.textContent=actual; acEl.style.color=actual<0?"var(--red)":"var(--blue)"; }

  p.stock_in_hq=hq; p.stock_in_transfer=tf;
  p.sales=sales; p.sample=sample; p.faulty=faulty; p.foc=foc;

  // Auto-set closing to actual unless user has overridden
  var closingEl=document.getElementById("closing-"+idx);
  if(closingEl && !p.closing_overridden){
    closingEl.value=actual; p.closing_cd=actual;
  }
  checkRemarks(idx);
  updateStockProgress();
}

function onStockInput(input){ recalcRow(parseInt(input.dataset.idx)); }

function onClosingInput(input){
  var idx=parseInt(input.dataset.idx), p=stockProducts[idx];
  p.closing_cd=input.value===""?null:parseFloat(input.value)||0;
  var acEl=document.getElementById("actual-"+idx);
  var actual=acEl?parseFloat(acEl.textContent)||0:0;
  p.closing_overridden=(p.closing_cd!==null && p.closing_cd!==actual);
  input.style.borderColor=p.closing_overridden?"var(--amber)":"var(--gold-border)";
  input.style.background=p.closing_overridden?"var(--amber-bg)":"var(--gold-bg)";
  checkRemarks(idx);
}

function checkRemarks(idx){
  var p=stockProducts[idx];
  var acEl=document.getElementById("actual-"+idx);
  var actual=acEl?parseFloat(acEl.textContent)||0:0;
  var rmEl=document.getElementById("remarks-"+idx); if(!rmEl) return;
  var needRmk=(p.closing_cd!==null && p.closing_cd!==actual);
  rmEl.style.display=needRmk?"block":"none";
  rmEl.style.borderColor=(needRmk&&!rmEl.value.trim())?"var(--red)":"var(--border2)";
}

function updateStockProgress(){
  var filled=stockProducts.filter(function(p){return p.sales!==null;}).length;
  document.getElementById("stockFilled").textContent=filled;
  // Never disable submit button â€” allow resubmit anytime
}

async function submitStock(){
  var emp=document.getElementById("stockEmpSelect").value;
  if(!emp){showToast("Please select employee","err");return;}
  // Validate remarks where closing â‰  actual
  for(var v=0;v<stockProducts.length;v++){
    var pv=stockProducts[v];
    var acEl=document.getElementById("actual-"+v);
    if(!acEl) continue;
    var actual=parseFloat(acEl.textContent)||0;
    if(pv.closing_cd!==null && pv.closing_cd!==actual && !(pv.remarks&&pv.remarks.trim())){
      showToast("Remarks required for: "+pv.name,"err");
      document.getElementById("remarks-"+v).focus(); return;
    }
  }
  var toSubmit=stockProducts.filter(function(p){return p.sales!==null||p.stock_in_hq||p.stock_in_transfer||p.sample||p.faulty||p.foc;});
  if(!toSubmit.length){showToast("Nothing to submit","err");return;}
  var btn=document.getElementById("submitStockBtn");
  btn.disabled=true; btn.textContent="Savingâ€¦";
  try{
    var resp=await fetch(SHEET_URL,{
      method:"POST",redirect:"follow",
      headers:{"Content-Type":"text/plain;charset=utf-8"},
      body:JSON.stringify({
        action:"submitStock",employee:emp,store:"Raya 2026",
        items:toSubmit.map(function(p){
          var acEl=document.getElementById("actual-"+stockProducts.indexOf(p));
          var actualVal=acEl?parseFloat(acEl.textContent)||0:0;
          return {sku:p.sku,name:p.name,par:p.par,
            opening_bd:p.opening_bd||0,stock_in_hq:p.stock_in_hq||0,
            stock_in_transfer:p.stock_in_transfer||0,sales:p.sales||0,
            sample:p.sample||0,faulty:p.faulty||0,foc:p.foc||0,
            closing_cd:p.closing_cd!==null?p.closing_cd:actualVal,
            remarks:p.remarks||""};
        })
      })
    });
    var r=await resp.json();
    var msg=r.resubmit?"Updated (overwritten today's data) â€” "+r.saved+" items":"Saved "+r.saved+" items âœ“";
    showToast(msg,"ok");
    document.getElementById("stockSubmittedBanner").style.display="block";
    btn.textContent="âœ… Submitted â€” Submit Again to Update"; btn.disabled=false;
    stockData=null;
  }catch(err){
    showToast("Save failed: "+err.message,"err");
    btn.disabled=false; btn.textContent="Submit Stock Count";
  }
}

// â”€â”€ Reorder Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadReorderTab(){
  // If we don't have fresh stock data, fetch it
  if(!stockData){
    try{ stockData=await jsonpFetch(SHEET_URL+"?action=stock"); }
    catch(err){ return; }
  }
  var products=stockData.products||[];
  var date=stockData.date||"";
  document.getElementById("reorderSubtitle").textContent="Based on stock count Â· "+date;

  var urgent=[],low=[],ok=[];
  products.forEach(function(p){
    if(p.closing_cd===null&&!p.submitted) return;
    var n=p.closing_cd!==null?Number(p.closing_cd):0, par=p.par, short=par-n;
    if(n>=par) ok.push(p);
    else if(n>=par*0.5) low.push({p:p,short:short});
    else urgent.push({p:p,short:short});
  });

  // Summary chips
  var sum=document.getElementById("reorderSummary");
  sum.innerHTML='<div class="sum-chip urgent"><div class="num">'+urgent.length+'</div><div class="lbl">URGENT</div></div>'
    +'<div class="sum-chip low"><div class="num">'+low.length+'</div><div class="lbl">LOW</div></div>'
    +'<div class="sum-chip ok"><div class="num">'+ok.length+'</div><div class="lbl">SUFFICIENT</div></div>';

  var grid=document.getElementById("reorderGrid");
  if(!stockData.submitted && products.every(function(p){return p.actual===null;})){
    grid.innerHTML='<div class="reorder-no-count"><p>No stock count submitted yet today.</p><button class="submit-stock-btn" onclick="switchTab(\'stock\')" style="background:var(--blue)">Go to Stock Count â†’</button></div>';
    return;
  }
  if(urgent.length===0&&low.length===0&&ok.length===0){
    grid.innerHTML='<div class="reorder-empty">No stock count data yet for today.</div>';
    return;
  }

  var html="";
  urgent.forEach(function(item){
    html+='<div class="reorder-card urgent"><div class="rc-icon">ğŸ”´</div><div class="rc-info"><div class="rc-name">'+item.p.name+'</div><div class="rc-sku">'+item.p.sku+' Â· '+item.p.unit+'</div></div><div class="rc-right"><div class="rc-qty urgent">+'+item.short+'</div><div class="rc-label">TO REORDER</div><div class="rc-actual">Have: '+(item.p.closing_cd!==null?item.p.closing_cd:0)+' / PAR: '+item.p.par+'</div></div></div>';
  });
  low.forEach(function(item){
    html+='<div class="reorder-card low"><div class="rc-icon">âš ï¸</div><div class="rc-info"><div class="rc-name">'+item.p.name+'</div><div class="rc-sku">'+item.p.sku+' Â· '+item.p.unit+'</div></div><div class="rc-right"><div class="rc-qty low">+'+item.short+'</div><div class="rc-label">TO REORDER</div><div class="rc-actual">Have: '+(item.p.closing_cd!==null?item.p.closing_cd:0)+' / PAR: '+item.p.par+'</div></div></div>';
  });
  ok.forEach(function(item){
    html+='<div class="reorder-card ok"><div class="rc-icon">âœ…</div><div class="rc-info"><div class="rc-name">'+item.name+'</div><div class="rc-sku">'+item.sku+' Â· '+item.unit+'</div></div><div class="rc-right"><div class="rc-qty ok">'+(item.closing_cd!==null?item.closing_cd:"â€”")+'</div><div class="rc-label">IN STOCK</div><div class="rc-actual">PAR: '+item.par+'</div></div></div>';
  });
  grid.innerHTML=html;
}

// â”€â”€ Sales Update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openUpdateModal(){
  var cur=(lastData&&lastData.daily_sales)?lastData.daily_sales:0;
  document.getElementById("umInput").value=cur||"";
  document.getElementById("updateModalBg").classList.add("open");
  setTimeout(function(){var el=document.getElementById("umInput");el.focus();el.select();},100);
}
function closeUpdateModal(){document.getElementById("updateModalBg").classList.remove("open");}
function confirmUpdate(){
  var val=parseFloat(document.getElementById("umInput").value);
  if(isNaN(val)||val<0){showToast("Please enter a valid amount","err");return;}

  // Update local display immediately
  if(lastData){
    var _old = lastData.daily_sales || 0;
    lastData.total_sales = (lastData.total_sales || 0) - _old + val;
    lastData.daily_sales = val;
    renderDash(lastData);
  }
  closeUpdateModal(); showToast("Savingâ€¦","info");

  // Code.gs calculates Total_Bonus and Overall_Comm from Sheets â€” just send daily_sales
  fetch(SHEET_URL,{method:"POST",redirect:"follow",headers:{"Content-Type":"text/plain;charset=utf-8"},
    body:JSON.stringify({action:"updateSales",daily_sales:val})
  }).then(function(resp){ return resp.json(); })
  .then(function(r){
    if(r.ok){
      showToast("Saved âœ“  Bonus: RM "+r.total_bonus+"  Comm: RM "+r.overall_comm,"ok");
    } else {
      showToast("Error: "+(r.error||"unknown"),"err");
    }
    // Re-fetch so dashboard reflects what was written to Sheets
    setTimeout(function(){ fetchSheets(true); }, 1000);
  }).catch(function(e){showToast("POST failed: "+e.message,"err");});
}
document.addEventListener("DOMContentLoaded",function(){
  document.getElementById("umInput").addEventListener("keydown",function(e){if(e.key==="Enter")confirmUpdate();if(e.key==="Escape")closeUpdateModal();});
});

// â”€â”€ Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startCam(){
  if(camStream) return;
  navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}})
    .then(function(stream){camStream=stream;var v=document.getElementById("video");v.srcObject=stream;v.style.display="block";document.getElementById("camIdle").style.display="none";document.getElementById("camRec").style.display="block";})
    .catch(function(){document.getElementById("camIdle").innerHTML='<div class="cam-idle-icon" style="opacity:.1">ğŸ“·</div><div class="cam-idle-text">NO CAMERA</div>';});
}
function stopCam(){
  if(!camStream) return;
  camStream.getTracks().forEach(function(t){t.stop();}); camStream=null;
  var v=document.getElementById("video"); v.srcObject=null; v.style.display="none";
  document.getElementById("camIdle").style.display="flex";
  document.getElementById("camIdle").innerHTML='<div class="cam-idle-icon">ğŸ“·</div><div class="cam-idle-text">SELECT EMPLOYEE</div>';
  document.getElementById("camRec").style.display="none";
}
function capturePhoto(){var v=document.getElementById("video"),c=document.getElementById("canvas");if(!camStream||v.readyState<2)return null;c.width=v.videoWidth;c.height=v.videoHeight;var ctx=c.getContext("2d");ctx.translate(c.width,0);ctx.scale(-1,1);ctx.drawImage(v,0,0);return c.toDataURL("image/jpeg",.6);}

// â”€â”€ Clock action â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doAction(type){
  if(!selEmp){showToast("Please select employee","err");return;}
  capturePhoto();
  var fl=document.getElementById("flash"); fl.classList.add("on"); setTimeout(function(){fl.classList.remove("on");},110);
  var now=new Date();
  var ts=now.toLocaleTimeString("en-MY",{hour12:false,hour:"2-digit",minute:"2-digit"});
  var ds=now.toLocaleDateString("en-MY");
  addFeed(selEmp,type,ts);
  showToast((type==="IN"?"Clocked In: ":"Clocked Out: ")+selEmp,"ok");
  fetch(SHEET_URL,{method:"POST",redirect:"follow",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({name:selEmp,type:type,date:ds,time:ts})}).catch(function(){});
  setTimeout(function(){selEmp=null;document.querySelectorAll(".emp-btn").forEach(function(b){b.classList.remove("sel");});stopCam();},1500);
}
function addFeed(name,type,time){
  var f=document.getElementById("feedScroll");
  var el=document.createElement("div"); el.className="feed-item";
  el.innerHTML='<div class="fdot '+(type==="IN"?"fdot-in":"fdot-out")+'"></div><span class="fname">'+name+'</span><span class="ftype">'+type+'</span><span class="ftime">'+time+'</span>';
  f.insertBefore(el,f.firstChild);
  while(f.children.length>15) f.removeChild(f.lastChild);
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg,type){
  var t=document.getElementById("toast"); t.textContent=msg; t.className="toast "+(type||"info");
  void t.offsetWidth; t.classList.add("show");
  setTimeout(function(){t.classList.remove("show");},2500);
}

// â”€â”€ Setup modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(){document.getElementById("s_url").value=SHEET_URL;document.getElementById("modalBg").classList.add("open");}
function closeModal(){document.getElementById("modalBg").classList.remove("open");}
async function testConn(){
  var url=document.getElementById("s_url").value.trim(), box=document.getElementById("statusBox");
  if(!url.endsWith("/exec")){box.innerHTML='<span class="warn">âš  URL must end with /exec</span>';return;}
  box.innerHTML='<span class="warn">Testingâ€¦</span>';
  try{
    var d=await jsonpFetch(url);
    box.innerHTML='<span class="'+(d.ok?"ok":"warn")+'">Row found: '+(d.ok?"YES âœ“":"NO âœ—")+'</span><br>'
      +'Today (script): '+d.date+'<br>'
      +'daily_sales (B): <b>RM '+(d.daily_sales||0)+'</b><br>'
      +'total_sales (C): <b>RM '+(d.total_sales||0)+'</b><br>'
      +'Employees: '+((d.employees||[]).join(", ")||"none")+'<br>'
      +'<span style="color:#888;font-size:10px">'+(d.debug||d.hint||"")+'</span>';
    setSyncUI("ok","LIVE"); renderDash(d); renderEmps(d.employees||[]);
  }catch(err){box.innerHTML='<span class="er">âœ— '+err.message+'</span>';setSyncUI("err","ERROR");}
}
function saveSettings(){SHEET_URL=document.getElementById("s_url").value.trim();closeModal();startAutoSync();showToast("Saved","ok");}

tick(); setInterval(tick,1000); startAutoSync();
</script>
</body>
</html>
